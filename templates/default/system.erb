# $Id: Generated by chef for node: <%= node['hostname'] %>
# ----------------------------------------------------------------
# NOTE: This file is controlled by chef templates!
# Do not edit or change this file but change the following:
#
# Cookbook Name:: nexenta_base
# Template:: system
#
# Copyright 2013, Schuberg Philis
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# Defaults
set nfs:nfs_allow_preepoch_time = 1
set zfs:zfs_resilver_delay = <%= node[:nexenta][:system][:zfs_resilver_delay] %>
set zfs:zfs_txg_synctime_ms = <%= node[:nexenta][:system][:zfs_txg_synctime_ms] %>
set zfs:zfs_txg_timeout = <%= node[:nexenta][:system][:zfs_txg_timeout] %>

# Non-Defaults
<% for setting, value in node[:nexenta][:system][:extra].each_pair do -%>
<%= "set #{setting} = #{value}" %>
<% end -%>

<% if @version == "3.1.3" || @version == "3.1.3.5" -%>
# Set if version is 3.1.3 or 3.1.3.5
set zfs:zfs_vdev_max_pending = 10
set zfs:zfs_resilver_min_time_ms = 3000

<% if node.attribute?("memory") -%>
# Dynamically set based on amount of memory.
<% case -%>
<% when node[:memory][:total].to_i > 190000 -%>
set zfs:zfs_arc_shrink_shift=11
<% when node[:memory][:total].to_i > 160000 -%>
set zfs:zfs_arc_shrink_shift=10
<% when node[:memory][:total].to_i > 120000 -%>
set zfs:zfs_arc_shrink_shift=9
<% when node[:memory][:total].to_i > 90000 -%>
set zfs:zfs_arc_shrink_shift=8
<% when node[:memory][:total].to_i > 60000 -%>
set zfs:zfs_arc_shrink_shift=7
<% else -%>
set zfs:zfs_arc_shrink_shift=5
<% end -%>

<% end -%>
<% elsif @version == "3.1.4" || @version == "3.1.4.1" -%>
# Set if version is 3.1.4 or 3.1.4.1
set nfs:nfs3_bsize = 131072
set nfs:nfs4_bsize = 131072
set nfs:nfs3_max_transfer_size_clts = 32768
set nfs:nfs4_max_transfer_size = 131072
set ddi_msix_alloc_limit = 6
set scsi_vhci:vhci_io_time = 30
set mpt_sas:mptsas_timeout_interval = 90
set mpt_sas:mptsas_timeout_threshold = 2
set zfs:zio_min_timeout_ms = 5000
set zfs:zio_max_timeout_ms = 30000
set sd:sd_io_time = 10
<% elsif @version == "3.1.4.2"|| @version == "3.1.5"  -%>
# Set if version is 3.1.4.2 or 3.1.5
# Defaults
set nfs:nfs3_bsize = 131072
set nfs:nfs4_bsize = 131072
set ddi_msix_alloc_limit = 6
set scsi_vhci:vhci_io_time = 30
set mpt_sas:mptsas_timeout_interval = 90
set mpt_sas:mptsas_timeout_threshold = 2
set zfs:zio_min_timeout_ms = 5000
set zfs:zio_max_timeout_ms = 30000
set sd:sd_io_time = 10
<% elsif @version == "3.1.6"  -%>
# Set if version is 3.1.6
# Defaults
set nfs:nfs3_bsize = 131072
set nfs:nfs4_bsize = 131072
set ddi_msix_alloc_limit = 6
set scsi_vhci:vhci_io_time = 30
set zfs:zfs_arc_max = 0x2000000000
<% end -%>
